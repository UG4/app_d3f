test-system:
  stage: test
  image: rockylinux:9.3
  timeout: 4 hours
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"
  parallel:
    matrix:
      - UG_BUILD_ID: build-serial-clang-15
        UG_CMAKE_PARALLEL: "OFF"
        UG_OMPI_CC: ""
        UG_OMPI_CXX: ""
        UG_C_COMPILER: "clang-15"
        UG_CXX_COMPILER: "clang++-15"
        UG_MPI: "mpi/openmpi-x86_64"
      - UG_BUILD_ID: build-parallel-clang-15
        UG_CMAKE_PARALLEL: "ON"
        UG_OMPI_CC: "clang-15"
        UG_OMPI_CXX: "clang++-15"
        UG_C_COMPILER: "mpicc"
        UG_CXX_COMPILER: "mpicxx"
        UG_MPI: "mpi/openmpi-x86_64"
      - UG_BUILD_ID: build-parallel-gcc-13
        UG_CMAKE_PARALLEL: "ON"
        UG_OMPI_CC: "gcc"
        UG_OMPI_CXX: "g++"
        UG_C_COMPILER: "mpicc"
        UG_CXX_COMPILER: "mpicxx"
        UG_MPI: "mpi/openmpi-x86_64"

  #tags:
  #  - ${PROVIDER}-${STACK}
  #environment: $PROVIDER/$STACK
  variables:
    UGHUB_DIR: "$CI_PROJECT_DIR/ughub"
    UG_DIR: "$CI_PROJECT_DIR/ug"
    GIT_ASKPASS: "$CI_PROJECT_DIR/cred.sh"
  before_script:
    # Copy into new subdir, but preserve '.gitlab' 
    - echo "Setting up base ug4 environment."
    - mkdir -p $UG_DIR/apps/app_d3f_plusplus
    - mv * $UG_DIR/apps/app_d3f_plusplus || true
    - mv $UG_DIR/apps/app_d3f_plusplus/.gitlab $CI_PROJECT_DIR/. || true
    # Linux stuff
    - dnf update -y >/dev/null
    - dnf install -y epel-release >/dev/null
    - dnf config-manager --enable epel >/dev/null
    - dnf config-manager --enable crb >/dev/null
    - dnf update -y >/dev/null
    - dnf install -y wget bats python3 python3-pip git cmake clang15 openblas-devel openmpi-devel environment-modules >/dev/null
    - dnf group install -y "Development Tools" >/dev/null
    - pip3 install vtk
    # Configure SSH keys 
    - git config --global credential.https://gitlab.com.username app_d3f_ci
    - echo "exec echo $UG4_ACCESS_TOKEN" > $CI_PROJECT_DIR/cred.sh
    - chmod +x $CI_PROJECT_DIR/cred.sh
    # Install ughub
    - cd $CI_PROJECT_DIR && git clone https://gitlab.com/ug4-project/ughub.git
    - export PATH="$PATH:$UGHUB_DIR"
    # Install UG4.
    - cd $UG_DIR
    - ughub init && ughub install ugcore ConvectionDiffusion Limex JSONForUG4 JSONToolkit ProMesh Richards SuperLU6 BoostForUG4
    - cd $UG_DIR/plugins/JSONToolkit
    - git submodule update --init --recursive
    - cd $UG_DIR/plugins/SuperLU6
    - git submodule update --init --recursive
    - cd $UG_DIR/externals/JSONForUG4
    - git submodule update --init --recursive
    - cd $UG_DIR/externals/AutodiffForUG4
    - git submodule update --init --recursive
    # Install additional plugins
    - git clone https://gitlab.com/ug4-project/quadruped/plugin_LevelSet.git $UG_DIR/plugins/LevelSet
    - if [[ "$UG_CMAKE_PARALLEL" == "ON" ]]; then git clone https://gitlab.com/ug4-project/quadruped/plugin_Parmetis.git $UG_DIR/plugins/plugin_Parmetis; fi
    - if [[ "$UG_CMAKE_PARALLEL" == "ON" ]]; then git clone https://gitlab.com/ug4-project/quadruped/plugin_Smile.git $UG_DIR/plugins/plugin_Smile; fi
    - git clone https://gitlab.com/ug4-project/plugins/plugin_d3f.git $UG_DIR/plugins/d3f
    # Checkout all repos to this branch (if exists).
    - cd $UG_DIR
    - find . -type d -name .git -exec sh -c "cd \"{}\"/../ && pwd && git checkout $CI_COMMIT_BRANCH || true" \;
    - find . -type d -name .git -exec sh -c "cd \"{}\"/../ && pwd && git checkout $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME || true" \;
  script:
    - echo "Building and testing ug4"
    # Prepare MPI.
    - source /etc/profile.d/modules.sh && module avail && module load $UG_MPI
    - export OMPI_CC=$UG_OMPI_CC
    - export OMPI_CXX=$UG_OMPI_CXX
    # Build ug4 in release.
    - cd $UG_DIR
    - mkdir -p $UG_BUILD_ID && cd $UG_BUILD_ID
    - cmake .. -DENABLE_ALL_PLUGINS=ON -DDEBUG=OFF -DCMAKE_BUILD_TYPE=Release -DPARALLEL=$UG_CMAKE_PARALLEL -DJSON=ON -DUSE_JSON=ON -DJSONToolkit=ON -DSuperLU6=ON -DCMAKE_CXX_COMPILER=$UG_CXX_COMPILER -DCMAKE_C_COMPILER=$UG_C_COMPILER
    - make -j8
    # Run lua tests.
    - cd $UG_DIR
    - source ugcore/scripts/shell/ugbash
    - bats -F junit --recursive apps/app_d3f_plusplus > $UG_DIR/report.xml
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - $UG_DIR/report.xml
      # - $UG_DIR/lib/*
      - $UG_DIR/bin/*
      - $UG_DIR/bin/plugins/*
      - $UG_DIR/**/test-artifacts/*
    reports:
      junit: $UG_DIR/report.xml
